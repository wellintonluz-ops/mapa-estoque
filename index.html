<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Estoque - Porta Pallets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        /* Style for the grid cells */
        .pallet-cell {
            transition: all 0.2s ease-in-out;
        }
        .pallet-cell:hover {
            background-color: #4b5563; /* gray-600 */
            z-index: 10;
        }
        .pallet-cell.selected {
            background-color: #fbbf24;
            border-color: #f59e0b;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.6);
            transform: scale(1.05);
            z-index: 20;
        }
        .pallet-cell.filled {
            background-color: #2563eb; /* blue-600 */
        }
        .pallet-cell.filled:hover {
            background-color: #1d4ed8; /* blue-700 */
        }
        .pallet-cell.partial-fill {
            background-color: #ef4444; /* red-500 */
        }
        .pallet-cell.partial-fill:hover {
            background-color: #dc2626; /* red-600 */
        }
        .pallet-cell.over-capacity {
            background-color: #f97316; /* orange-500 */
        }
        .pallet-cell.over-capacity:hover {
            background-color: #ea580c; /* orange-600 */
        }
        .menu-text {
            transition: opacity 0.2s ease-in-out, width 0.2s ease-in-out;
        }
        /* Active menu item styles */
        .active-menu-item {
            background-color: #374151; /* gray-700 */
        }
        a[data-rack="import"].active-menu-item { background-color: #0F766E; } /* teal-700 */
        a[data-rack="params"].active-menu-item { background-color: #7E22CE; } /* purple-700 */
        a[data-rack="forecast"].active-menu-item { background-color: #059669; } /* green-600 */
        a[data-rack="programming"].active-menu-item { background-color: #BE185D; } /* pink-700 */
        a[data-rack="instructions"].active-menu-item { background-color: #4338CA; } /* indigo-700 */
        a[data-rack="all"].active-menu-item { background-color: #B45309; } /* amber-700 */

        .uppercase-input {
            text-transform: uppercase;
        }
        .uppercase-input::placeholder {
            text-transform: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-gray-800 shadow-lg p-4 z-30">
            <h1 class="text-2xl font-bold text-center text-amber-400">Mapa de Estoque Interativo</h1>
            <div id="global-stats-panel" class="text-center text-gray-300 mt-2 text-sm"></div>
            <p id="details-panel" class="text-center text-gray-300 mt-1 h-6">Carregando dados...</p>
        </header>

        <!-- Main Content -->
        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar with Rack Selector -->
            <nav id="sidebar" class="group w-16 hover:w-56 bg-gray-800 p-2 overflow-y-auto custom-scrollbar transition-all duration-300 ease-in-out">
                <ul id="rack-selector" class="space-y-2 mt-4">
                    <!-- Links will be generated here -->
                </ul>
            </nav>

            <!-- Rack Display Area -->
            <main id="main-content" class="flex-1 p-4 md:p-6 lg:p-8 overflow-auto custom-scrollbar">
                <!-- Content will be generated here -->
            </main>
        </div>
    </div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";

        document.addEventListener('DOMContentLoaded', () => {
            const rackSelector = document.getElementById('rack-selector');
            const mainContent = document.getElementById('main-content');
            const detailsPanel = document.getElementById('details-panel');
            const globalStatsPanel = document.getElementById('global-stats-panel');
            
            // --- FIREBASE SETUP ---
            const firebaseConfigFromEnv = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            const firebaseConfig = firebaseConfigFromEnv || {
                apiKey: "AIzaSyDi9i59ySZSaBnniQUwBKcKlst2PA8AgTc",
                authDomain: "mapa-estoque.firebaseapp.com",
                projectId: "mapa-estoque",
                storageBucket: "mapa-estoque.appspot.com",
                messagingSenderId: "877978797929",
                appId: "1:877978797929:web:3a6c7c006a32fe5d0b5ff8",
                measurementId: "G-4GNC5SKF17"
            };
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            let userId = null;
            let isInitialLoad = true;
            let activeRackId = 'all';
            let nextRenderMessage = null;
            // --- END FIREBASE SETUP ---

            const DEFAULT_INSTRUCTIONS = [
                { title: 'PORTA PALLETS 01 AO 10', content: 'AQUI VAI A INSTRUÇÃO PARA OS PORTA-PALLETS DE 1 A 10. EX: ARMAZENAR PRODUTOS DA CATEGORIA A, ALTA ROTATIVIDADE, ELETRÔNICOS.' },
                { title: 'PORTA PALLETS 11 AO 26', content: 'INSTRUÇÃO PARA OS PORTA-PALLETS DE 11 A 26. EX: ARMAZENAR PRODUTOS DA CATEGORIA B, MÉDIA ROTATIVIDADE, ELETRODOMÉSTICOS.' },
                { title: 'REGRA GERAL', content: 'QUALQUER OUTRA REGRA GERAL OU LEGENDA PODE SER ADICIONADA AQUI.' }
            ];

            let INSTRUCTIONS_DATA = [];
            let inventoryState = {};
            let PRODUCT_PARAMS_DATA = [];
            let PROGRAMMING_DATA = [];
            let FORECAST_DATA = {};
            
            const WAREHOUSE_CONFIG = {
                totalRacks: 26,
                levelLetters: ['F', 'E', 'D', 'C', 'B', 'A'],
                levelMap: { 'F': '06', 'E': '05', 'D': '04', 'C': '03', 'B': '02', 'A': '01' },
                sides: ['A', 'B'],
                getColsForRack: (rackNumber) => {
                    if (rackNumber >= 1 && rackNumber <= 10) return 21;
                    if (rackNumber >= 11 && rackNumber <= 26) return 16;
                    return 0;
                }
            };
            
            let selectedCell = null;

            function updateGlobalStats(sourceInventory = inventoryState) {
                let grandTotalPositions = 0;
                for (let i = 1; i <= WAREHOUSE_CONFIG.totalRacks; i++) {
                    const cols = WAREHOUSE_CONFIG.getColsForRack(i);
                    grandTotalPositions += cols * WAREHOUSE_CONFIG.levelLetters.length * WAREHOUSE_CONFIG.sides.length;
                }

                const totalOccupied = Object.keys(sourceInventory).length;
                 const totalItems = Object.values(sourceInventory).reduce((sum, item) => {
                    const quantity = parseFloat(item.quantity);
                    return sum + (isNaN(quantity) ? 0 : quantity);
                }, 0);
                const globalPercentage = grandTotalPositions > 0 ? ((totalOccupied / grandTotalPositions) * 100).toFixed(1) : 0;

                globalStatsPanel.innerHTML = `
                    <span class="font-semibold text-white">Total de Posições: ${grandTotalPositions.toLocaleString('pt-BR')}</span> | 
                    <span class="font-semibold text-red-400">Posições Ocupadas: ${totalOccupied.toLocaleString('pt-BR')}</span> | 
                    <span class="font-bold text-amber-400">Ocupação (Posições): ${globalPercentage}%</span> |
                    <span class="font-semibold text-cyan-400">Soma Total de Itens: ${Math.round(totalItems).toLocaleString('pt-BR')}</span>
                `;
            }

            async function saveData() {
                if (!auth.currentUser) {
                    console.error("Usuário não autenticado. Não é possível salvar.");
                    return;
                }
                const publicDocRef = doc(db, "artifacts", appId, "public/data/mapData", "singleton");
                try {
                    await setDoc(publicDocRef, {
                        inventoryState: JSON.stringify(inventoryState),
                        INSTRUCTIONS_DATA,
                        PRODUCT_PARAMS_DATA,
                        PROGRAMMING_DATA,
                        FORECAST_DATA: JSON.stringify(FORECAST_DATA)
                    });
                } catch (error) {
                    console.error("Erro ao salvar dados no Firestore: ", error);
                }
            }

            function setupRealtimeListener() {
                if (!auth.currentUser) {
                    console.error("User not authenticated. Cannot set up listener.");
                    return;
                }
                const publicDocRef = doc(db, "artifacts", appId, "public/data/mapData", "singleton");
                
                onSnapshot(publicDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        INSTRUCTIONS_DATA = data.INSTRUCTIONS_DATA || DEFAULT_INSTRUCTIONS;
                        try {
                            inventoryState = data.inventoryState ? JSON.parse(data.inventoryState) : {};
                        } catch (e) {
                            console.error("Error parsing inventoryState from Firestore:", e);
                            inventoryState = {};
                        }
                        try {
                            FORECAST_DATA = data.FORECAST_DATA ? JSON.parse(data.FORECAST_DATA) : {};
                        } catch (e) {
                            console.error("Error parsing FORECAST_DATA from Firestore:", e);
                            FORECAST_DATA = {};
                        }
                        PRODUCT_PARAMS_DATA = data.PRODUCT_PARAMS_DATA || [];
                        PROGRAMMING_DATA = data.PROGRAMMING_DATA || [];
                    } else {
                        console.log("No data found, creating new public document.");
                        INSTRUCTIONS_DATA = DEFAULT_INSTRUCTIONS;
                        inventoryState = {};
                        PRODUCT_PARAMS_DATA = [];
                        PROGRAMMING_DATA = [];
                        FORECAST_DATA = {};
                        saveData(); // Create the initial document
                    }

                    if (isInitialLoad) {
                        isInitialLoad = false;
                        detailsPanel.textContent = 'Selecione uma posição para ver os detalhes';
                        createRackSelector();
                        const firstRackLink = rackSelector.querySelector(`a[data-rack="${activeRackId}"]`);
                        if (firstRackLink) {
                            setActiveMenuItem(firstRackLink);
                            refreshCurrentView();
                        }
                    } else {
                        refreshCurrentView();
                    }
                });
            }

            function refreshCurrentView() {
                const message = nextRenderMessage;
                nextRenderMessage = null; // Consume message

                const currentRackId = activeRackId;
                switch(currentRackId) {
                    case 'import': displayImportScreen(); break;
                    case 'instructions': displayInstructions(); break;
                    case 'params': displayProductParamsScreen(!!message, message); break;
                    case 'programming': displayProgrammingScreen(!!message, message); break;
                    case 'forecast': displayForecastScreen(!!message, message); break;
                    case 'all': displayAllRacks(); break;
                    default: displaySingleRack(parseInt(currentRackId, 10)); break;
                }
                updateGlobalStats();
            }

            function createRackSelector() {
                rackSelector.innerHTML = '';

                const icons = {
                    import: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>`,
                    params: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>`,
                    forecast: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>`,
                    programming: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>`,
                    instructions: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>`,
                    all: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>`,
                    rack: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>`
                };

                const createMenuItem = (rackId, text, icon, colorClasses, isRackLink = false) => {
                    const listItem = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = '#';
                    link.dataset.rack = rackId;
                    let finalClasses = `flex items-center w-full justify-center group-hover:justify-start p-2 rounded-md font-medium transition-colors duration-200 ${colorClasses}`;
                    if (isRackLink) finalClasses += ' rack-link';
                    link.className = finalClasses;
                    
                    link.innerHTML = `
                        <div class="flex-shrink-0">${icon}</div>
                        <span class="menu-text opacity-0 w-0 group-hover:w-auto group-hover:opacity-100 whitespace-nowrap ml-3 transition-all duration-200">${text}</span>
                    `;
                    listItem.appendChild(link);
                    rackSelector.appendChild(listItem);
                };

                createMenuItem('import', 'Importar Relatório', icons.import, 'bg-teal-600 text-white hover:bg-teal-500');
                createMenuItem('params', 'Parâmetros', icons.params, 'bg-purple-600 text-white hover:bg-purple-500');
                createMenuItem('forecast', 'Forecast', icons.forecast, 'bg-green-600 text-white hover:bg-green-500');
                createMenuItem('programming', 'Programação', icons.programming, 'bg-pink-600 text-white hover:bg-pink-500');
                createMenuItem('instructions', 'Instruções', icons.instructions, 'bg-indigo-600 text-white hover:bg-indigo-500');
                createMenuItem('all', 'Visualizar Todos', icons.all, 'bg-amber-600 text-white hover:bg-amber-500');
                
                const separator = document.createElement('hr');
                separator.className = "border-gray-700 my-4";
                rackSelector.appendChild(separator);
                
                for (let i = 1; i <= WAREHOUSE_CONFIG.totalRacks; i++) {
                     createMenuItem(i, `Porta Pallet ${String(i).padStart(2, '0')}`, icons.rack, 'text-gray-400 hover:bg-gray-700 hover:text-white', true);
                }
            }
            
            function createRackGridElement(rackNumber, sourceInventory = inventoryState) {
                const cols = WAREHOUSE_CONFIG.getColsForRack(rackNumber);
                const grid = document.createElement('div');
                grid.className = 'grid gap-1.5';
                grid.style.gridTemplateColumns = `repeat(${cols}, 80px)`;

                WAREHOUSE_CONFIG.levelLetters.forEach(levelLetter => {
                    for (let col = 1; col <= cols; col++) {
                        const positionContainer = document.createElement('div');
                        positionContainer.className = 'flex aspect-square rounded-sm overflow-hidden';
                        const levelNum = WAREHOUSE_CONFIG.levelMap[levelLetter];

                        WAREHOUSE_CONFIG.sides.forEach((side, index) => {
                            const cell = document.createElement('div');
                            const address = `PP${String(rackNumber).padStart(2, '0')}.${String(col).padStart(2, '0')}.${levelNum}.${side}`;
                            cell.dataset.address = address;
                            
                            let cellClasses = 'pallet-cell flex-1 h-full bg-gray-700 cursor-pointer flex items-center justify-center';
                            if (index === 0) {
                                cellClasses += ' border-r border-black';
                            }
                            cell.className = cellClasses;

                            const data = sourceInventory[address];
                            if (data) {
                                cell.title = `${address}\nProduto: ${data.item}\nQtd: ${data.quantity}`;
                                if (data.percentage !== undefined && !isNaN(data.percentage)) {
                                     if (data.percentage > 100) {
                                        cell.classList.add('over-capacity');
                                    } else if (data.percentage < 99.9) {
                                        cell.classList.add('partial-fill');
                                    } else {
                                        cell.classList.add('filled');
                                    }
                                    cell.innerHTML = `<span class="text-xs font-bold pointer-events-none">${Math.round(data.percentage)}%</span>`;
                                } else {
                                    cell.classList.add('filled');
                                }
                            } else {
                                cell.title = address;
                            }

                            cell.addEventListener('click', () => handleCellClick(cell, sourceInventory));
                            cell.addEventListener('dblclick', () => {
                                if (sourceInventory === inventoryState) {
                                    handleCellToggle(cell, rackNumber);
                                }
                            });
                            positionContainer.appendChild(cell);
                        });
                        grid.appendChild(positionContainer);
                    }
                });
                return grid;
            }
            
            function updateRackStats(rackNumber, sourceInventory = inventoryState) {
                const statsContainer = document.getElementById(`stats-rack-${rackNumber}`);
                if (!statsContainer) return;

                const cols = WAREHOUSE_CONFIG.getColsForRack(rackNumber);
                const totalPositions = cols * WAREHOUSE_CONFIG.levelLetters.length * WAREHOUSE_CONFIG.sides.length;
                
                let filledCount = 0;
                const rackPrefix = `PP${String(rackNumber).padStart(2, '0')}`;
                Object.keys(sourceInventory).forEach(address => {
                    if (address.startsWith(rackPrefix)) {
                        filledCount++;
                    }
                });

                const emptyCount = totalPositions - filledCount;
                const percentage = totalPositions > 0 ? ((filledCount / totalPositions) * 100).toFixed(1) : 0;

                statsContainer.innerHTML = `
                    <span class="text-sm font-normal text-gray-400">
                        ${cols} Colunas | Posições: 
                        <span class="font-semibold text-white">${totalPositions}</span> Total | 
                        <span class="font-semibold text-green-400">${emptyCount}</span> Vazias | 
                        <span class="font-semibold text-red-400">${filledCount}</span> Preenchidas |
                        <span class="font-bold text-amber-400">${percentage}% Ocupado</span>
                    </span>
                `;
            }

            function displaySingleRack(rackNumber) {
                mainContent.innerHTML = '';
                const container = document.createElement('div');
                const titleContainer = document.createElement('div');
                titleContainer.className = 'text-center mb-4';
                const title = document.createElement('h3');
                title.className = 'text-2xl font-bold';
                title.textContent = `Porta Pallet ${String(rackNumber).padStart(2, '0')}`;
                const stats = document.createElement('div');
                stats.id = `stats-rack-${rackNumber}`;
                titleContainer.appendChild(title);
                titleContainer.appendChild(stats);
                const grid = createRackGridElement(rackNumber);
                container.appendChild(titleContainer);
                container.appendChild(grid);
                mainContent.appendChild(container);
                updateRackStats(rackNumber);
                resetSelection();
            }

            function displayAllRacks(sourceInventory = inventoryState) {
                mainContent.innerHTML = '';
                
                const simulationHeader = document.createElement('div');
                simulationHeader.className = 'flex justify-center items-center gap-4 mb-8 p-4 bg-gray-800 rounded-lg';
                simulationHeader.innerHTML = `
                    <div>
                        <label for="simulation-date" class="mr-2 font-semibold">Simular para o dia:</label>
                        <input type="date" id="simulation-date" class="bg-gray-700 text-white rounded-md p-2">
                    </div>
                    <button id="run-simulation-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-md font-semibold">Simular Dia</button>
                    <button id="clear-simulation-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md font-semibold">Limpar Simulação</button>
                    <p id="simulation-status" class="text-sm text-gray-400 h-6 ml-4"></p>
                `;
                mainContent.appendChild(simulationHeader);

                document.getElementById('run-simulation-btn').onclick = () => {
                    const date = document.getElementById('simulation-date').value;
                    const statusEl = document.getElementById('simulation-status');
                    if (date) {
                        if(statusEl) statusEl.textContent = 'Calculando...';
                        setTimeout(() => {
                            runSimulation(date);
                        }, 50); 
                    } else {
                        if(statusEl) statusEl.textContent = 'Selecione uma data.';
                        setTimeout(() => { if(statusEl) statusEl.textContent = ''; }, 2000);
                    }
                };
                
                document.getElementById('clear-simulation-btn').onclick = () => {
                    displayAllRacks(inventoryState);
                    updateGlobalStats(inventoryState);
                };

                for (let i = 1; i <= WAREHOUSE_CONFIG.totalRacks; i++) {
                    const rackContainer = document.createElement('div');
                    rackContainer.className = 'mb-12';
                    const title = document.createElement('h3');
                    title.className = 'text-xl font-semibold text-amber-400';
                    title.textContent = `Porta Pallet ${String(i).padStart(2, '0')}`;
                    const stats = document.createElement('div');
                    stats.id = `stats-rack-${i}`;
                    stats.className = 'mb-3';
                    const grid = createRackGridElement(i, sourceInventory);
                    rackContainer.appendChild(title);
                    rackContainer.appendChild(stats);
                    rackContainer.appendChild(grid);
                    mainContent.appendChild(rackContainer);
                    updateRackStats(i, sourceInventory);
                }
                resetSelection();
            }

            function displayInstructions() {
                mainContent.innerHTML = '';
                
                const header = document.createElement('div');
                header.className = 'flex justify-between items-center mb-6';
                
                const title = document.createElement('h2');
                title.className = 'text-2xl font-bold text-amber-400';
                title.textContent = 'Instruções de Armazenagem';
                header.appendChild(title);

                const addButton = document.createElement('button');
                addButton.textContent = 'Adicionar Nova Instrução';
                addButton.className = 'px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-md font-semibold transition-colors duration-150';
                addButton.onclick = () => {
                    INSTRUCTIONS_DATA.push({ title: 'Nova Instrução', content: '' });
                    displayInstructions();
                };
                header.appendChild(addButton);
                mainContent.appendChild(header);

                const container = document.createElement('div');
                container.id = 'instructions-container';
                container.className = 'space-y-6';

                INSTRUCTIONS_DATA.forEach((item, index) => {
                    const instructionBlock = document.createElement('div');
                    instructionBlock.className = 'instruction-block bg-gray-800 p-4 rounded-lg shadow';
                    
                    const blockHeader = document.createElement('div');
                    blockHeader.className = 'flex justify-between items-center mb-2';

                    const titleInput = document.createElement('input');
                    titleInput.type = 'text';
                    titleInput.value = item.title;
                    titleInput.className = 'uppercase-input text-lg font-semibold text-white bg-transparent border-b-2 border-gray-700 focus:border-amber-500 outline-none w-full mr-4 transition';
                    blockHeader.appendChild(titleInput);
                    
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Remover';
                    deleteButton.className = 'px-3 py-1 bg-red-700 hover:bg-red-600 rounded-md text-sm font-medium transition-colors duration-150';
                    deleteButton.onclick = () => {
                        INSTRUCTIONS_DATA.splice(index, 1);
                        displayInstructions();
                    };
                    blockHeader.appendChild(deleteButton);

                    const contentTextarea = document.createElement('textarea');
                    contentTextarea.className = 'uppercase-input w-full h-24 bg-gray-700 text-gray-300 p-2 rounded-md border border-gray-600 focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition';
                    contentTextarea.value = item.content;

                    instructionBlock.appendChild(blockHeader);
                    instructionBlock.appendChild(contentTextarea);
                    container.appendChild(instructionBlock);
                });

                const saveButton = document.createElement('button');
                saveButton.textContent = 'Salvar Alterações';
                saveButton.className = 'mt-6 px-4 py-2 bg-green-600 hover:bg-green-500 rounded-md font-semibold transition-colors duration-150';
                saveButton.onclick = () => {
                    const newInstructionData = [];
                    document.querySelectorAll('.instruction-block').forEach(block => {
                        const title = block.querySelector('input').value;
                        const content = block.querySelector('textarea').value;
                        if (title.trim() || content.trim()) {
                            newInstructionData.push({ title, content });
                        }
                    });
                    INSTRUCTIONS_DATA = newInstructionData;
                    saveData();
                    saveButton.textContent = 'Salvo!';
                    setTimeout(() => { saveButton.textContent = 'Salvar Alterações'; }, 2000);
                };

                mainContent.appendChild(container);
                if (INSTRUCTIONS_DATA.length > 0) {
                    mainContent.appendChild(saveButton);
                }
            }

            function displayImportScreen() {
                mainContent.innerHTML = `
                    <div class="max-w-2xl mx-auto">
                        <h2 class="text-2xl font-bold mb-4 text-amber-400">Importar Relatório de Estoque</h2>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <p class="text-gray-300 mb-4">Cole o conteúdo do seu relatório na área abaixo ou carregue um arquivo (.txt, .csv).</p>
                            <p class="text-sm text-gray-400 mb-4">O formato esperado é: <code class="bg-gray-900 px-2 py-1 rounded">POSIÇÃO,Itens,Quantidade</code> por linha. O separador pode ser vírgula, ponto e vírgula ou tabulação.</p>
                            
                            <textarea id="import-textarea" class="uppercase-input w-full h-48 bg-gray-700 text-gray-300 p-3 rounded-md border border-gray-600 focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition" placeholder="Ex: PP01.01.01.A,PRODUTO EXEMPLO,100&#10;PP01.01.01.B,PRODUTO Y,50&#10;PP01.01.02.A,PRODUTO Z,200&#10;PP01.01.02.B,; (Para esvaziar esta posição)"></textarea>

                            <div class="mt-4 flex items-center justify-between">
                                <label for="file-upload" class="cursor-pointer px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md font-semibold transition-colors duration-150">
                                    Carregar Arquivo
                                </label>
                                <input id="file-upload" type="file" class="hidden" accept=".csv,.txt">
                                <button id="import-button" class="px-6 py-2 bg-green-600 hover:bg-green-500 rounded-md font-semibold transition-colors duration-150">Importar Dados</button>
                            </div>
                             <p id="import-status" class="text-center mt-4 h-6"></p>
                        </div>
                    </div>
                `;

                const fileUpload = document.getElementById('file-upload');
                const textarea = document.getElementById('import-textarea');
                
                fileUpload.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            textarea.value = e.target.result;
                        };
                        reader.readAsText(file);
                    }
                });

                document.getElementById('import-button').addEventListener('click', () => {
                    const data = textarea.value;
                    if (!data.trim()) {
                        document.getElementById('import-status').textContent = 'Nenhum dado para importar.';
                        return;
                    }

                    const lines = data.split(/\r?\n/);
                    let updatedCount = 0;
                    let errorCount = 0;
                    const positionRegex = /^PP\d{2}\.\d{2}\.\d{2}\.[AB]$/i;

                    lines.forEach(line => {
                        if (!line.trim()) return;
                        if (line.toLowerCase().includes('posição')) return;

                        const parts = line.split(/[,;\t]/);
                        if (parts.length >= 3) {
                            const position = parts[0].trim().toUpperCase();
                            const item = parts[1].trim().toUpperCase();
                            const quantity = parts[2].trim();

                            if (positionRegex.test(position)) {
                                if (item === '' && quantity === '') {
                                    delete inventoryState[position];
                                } else {
                                    const productParam = PRODUCT_PARAMS_DATA.find(p => p.code.toUpperCase() === item.toUpperCase());
                                    const maxQty = productParam ? parseFloat(productParam.maxQty) : 0;
                                    let percentage = 100; // Default to 100% if no param is found
                                    if(maxQty > 0) {
                                        percentage = (parseFloat(quantity) / maxQty) * 100;
                                    }
                                    inventoryState[position] = { item, quantity, percentage };
                                }
                                updatedCount++;
                            } else {
                                errorCount++;
                            }
                        } else if (line.trim()) {
                             errorCount++;
                        }
                    });

                    saveData();
                    const statusEl = document.getElementById('import-status');
                    statusEl.textContent = `Importação concluída! ${updatedCount} posições atualizadas. ${errorCount} linhas com erro. Atualizando o mapa...`;
                    statusEl.classList.add('text-green-400');
                    
                    setTimeout(() => {
                        const allLink = document.querySelector('a[data-rack="all"]');
                        if (allLink) allLink.click();
                    }, 2500);
                });
            }
            
            function displayProductParamsScreen(showConfirmation = false) {
                mainContent.innerHTML = '';
                
                const header = document.createElement('div');
                header.className = 'flex justify-between items-center mb-6';
                
                const title = document.createElement('h2');
                title.className = 'text-2xl font-bold text-amber-400';
                title.textContent = 'Cadastro de Produtos';
                header.appendChild(title);

                if (showConfirmation) {
                    const confirmation = document.createElement('span');
                    confirmation.className = 'ml-4 text-lg font-normal text-green-400';
                    confirmation.textContent = 'Salvo com sucesso!';
                    title.appendChild(confirmation);
                    setTimeout(() => {
                        confirmation.remove();
                    }, 2500);
                }
                
                const buttonsContainer = document.createElement('div');
                buttonsContainer.className = 'flex items-center gap-4';

                const importLabel = document.createElement('label');
                importLabel.htmlFor = 'params-file-upload';
                importLabel.className = 'cursor-pointer px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md font-semibold transition-colors duration-150';
                importLabel.textContent = 'Carregar Lote (.csv, .xlsx)';
                buttonsContainer.appendChild(importLabel);
                
                const fileInput = document.createElement('input');
                fileInput.id = 'params-file-upload';
                fileInput.type = 'file';
                fileInput.className = 'hidden';
                fileInput.accept = '.csv,.txt,.xls,.xlsx';
                buttonsContainer.appendChild(fileInput);

                const addButton = document.createElement('button');
                addButton.textContent = 'Adicionar Novo Produto';
                addButton.className = 'px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-md font-semibold transition-colors duration-150';
                buttonsContainer.appendChild(addButton);

                header.appendChild(buttonsContainer);
                mainContent.appendChild(header);

                const container = document.createElement('div');
                container.id = 'params-container';
                container.className = 'space-y-4';

                const tableHeader = document.createElement('div');
                tableHeader.className = 'grid grid-cols-12 gap-4 px-4 text-sm font-bold text-gray-400 uppercase';
                tableHeader.innerHTML = `
                    <div class="col-span-9">Código do Produto</div>
                    <div class="col-span-2 text-center">Qtd. Máxima na Locação</div>
                    <div class="col-span-1"></div>
                `;
                container.appendChild(tableHeader);

                const createParamBlock = (item, parent) => {
                    const paramBlock = document.createElement('div');
                    paramBlock.className = 'param-block bg-gray-800 p-3 rounded-lg grid grid-cols-12 gap-4 items-center';
                    
                    paramBlock.innerHTML = `
                        <input type="text" value="${item.code || ''}" placeholder="Ex: PROD-001" class="uppercase-input param-code col-span-9 bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition">
                        <input type="number" value="${item.maxQty || ''}" placeholder="Ex: 100" class="param-max-qty col-span-2 bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition text-center">
                        <button class="remove-btn col-span-1 px-3 py-2 bg-red-700 hover:bg-red-600 rounded-md text-sm font-medium transition-colors duration-150">Remover</button>
                    `;
                    
                    paramBlock.querySelector('.remove-btn').onclick = () => paramBlock.remove();
                    parent.appendChild(paramBlock);
                };
                
                addButton.onclick = () => createParamBlock({}, container);

                PRODUCT_PARAMS_DATA.forEach(item => createParamBlock(item, container));
                
                fileInput.addEventListener('change', (event) => {
                    processUploadedFile(event.target.files[0], (data) => {
                         data.forEach(row => {
                            if (String(row[0]).toLowerCase().includes('código')) return; 
                            if (row.length >= 2) {
                                createParamBlock({ code: row[0], maxQty: row[1] }, container);
                            }
                        });
                        fileInput.value = '';
                    });
                });


                const saveButton = document.createElement('button');
                saveButton.textContent = 'Salvar Alterações';
                saveButton.className = 'mt-6 px-4 py-2 bg-green-600 hover:bg-green-500 rounded-md font-semibold transition-colors duration-150';
                saveButton.onclick = () => {
                    const newParamsData = [];
                    mainContent.querySelectorAll('#params-container .param-block').forEach(block => {
                        const code = block.querySelector('.param-code').value.trim().toUpperCase();
                        const maxQty = block.querySelector('.param-max-qty').value.trim();
                        if (code || maxQty) {
                            newParamsData.push({ code, maxQty });
                        }
                    });
                    
                    PRODUCT_PARAMS_DATA = newParamsData;

                    Object.keys(inventoryState).forEach(address => {
                        const stockItem = inventoryState[address];
                        if (stockItem && stockItem.item !== 'OCUPADO MANUALMENTE') {
                            const productParam = newParamsData.find(p => p.code.toUpperCase() === stockItem.item.toUpperCase());
                            if (productParam) {
                                const maxQty = parseFloat(productParam.maxQty);
                                if (maxQty > 0) {
                                    stockItem.percentage = (parseFloat(stockItem.quantity) / maxQty) * 100;
                                } else {
                                    stockItem.percentage = 100; 
                                }
                            }
                        }
                    });

                    saveData();
                    displayProductParamsScreen(true);
                };
                
                mainContent.appendChild(container);
                mainContent.appendChild(saveButton);
            }

            function handleCellToggle(cell, rackNumber) {
                const address = cell.dataset.address;
                if (inventoryState[address]) {
                    delete inventoryState[address];
                } else {
                    inventoryState[address] = { item: 'OCUPADO MANUALMENTE', quantity: '-' };
                }
                saveData();
            }

            function handleCellClick(cell, sourceInventory = inventoryState) {
                if (selectedCell) {
                    selectedCell.classList.remove('selected');
                }
                if (selectedCell === cell) {
                    resetSelection();
                    return;
                }
                cell.classList.add('selected');
                selectedCell = cell;
                const address = cell.dataset.address;
                const data = sourceInventory[address];

                if (data) {
                    let detailsHTML = `
                        <span class="font-bold text-amber-300">${address}</span> | 
                        <span class="text-white">Item: ${data.item}</span> | 
                        <span class="text-white">Qtd: ${data.quantity}</span>
                    `;
                    if (data.percentage !== undefined && !isNaN(data.percentage)) {
                        detailsHTML += ` | <span class="text-white">Ocupação: <span class="font-semibold">${data.percentage.toFixed(1)}%</span></span>`;
                    }
                    detailsPanel.innerHTML = detailsHTML;
                } else {
                    detailsPanel.innerHTML = `Posição Selecionada: <span class="font-bold text-amber-300">${address}</span>`;
                }
            }

            function resetSelection() {
                detailsPanel.textContent = 'Selecione uma posição para ver os detalhes';
                if (selectedCell) {
                    selectedCell.classList.remove('selected');
                    selectedCell = null;
                }
            }
            
            function setActiveMenuItem(target) {
                if(!target) return;
                document.querySelectorAll('#rack-selector a').forEach(a => {
                    a.classList.remove('active-menu-item');
                });
                target.classList.add('active-menu-item');
            }

            rackSelector.addEventListener('click', (event) => {
                const target = event.target.closest('a');
                if (target) {
                    event.preventDefault();
                    activeRackId = target.dataset.rack;
                    setActiveMenuItem(target);
                    refreshCurrentView();
                }
            });

            function displayProgrammingScreen(showConfirmation = false) {
                mainContent.innerHTML = '';
                
                const header = document.createElement('div');
                header.className = 'flex justify-between items-center mb-6';
                
                const title = document.createElement('h2');
                title.className = 'text-2xl font-bold text-amber-400';
                title.textContent = 'Programação de Chegadas';
                header.appendChild(title);

                 if (showConfirmation) {
                    const confirmation = document.createElement('span');
                    confirmation.className = 'ml-4 text-lg font-normal text-green-400';
                    confirmation.textContent = 'Salvo com sucesso!';
                    title.appendChild(confirmation);
                    setTimeout(() => confirmation.remove(), 2500);
                }

                const buttonsContainer = document.createElement('div');
                buttonsContainer.className = 'flex items-center gap-4';

                const importLabel = document.createElement('label');
                importLabel.htmlFor = 'programming-file-upload';
                importLabel.className = 'cursor-pointer px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md font-semibold transition-colors duration-150';
                importLabel.textContent = 'Carregar Lote (.csv, .xlsx)';
                buttonsContainer.appendChild(importLabel);
                
                const fileInput = document.createElement('input');
                fileInput.id = 'programming-file-upload';
                fileInput.type = 'file';
                fileInput.className = 'hidden';
                fileInput.accept = '.csv,.txt,.xls,.xlsx';
                buttonsContainer.appendChild(fileInput);

                const addButton = document.createElement('button');
                addButton.textContent = 'Adicionar Programação';
                addButton.className = 'px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-md font-semibold transition-colors duration-150';
                buttonsContainer.appendChild(addButton);

                header.appendChild(buttonsContainer);
                mainContent.appendChild(header);


                const container = document.createElement('div');
                container.id = 'programming-container';
                container.className = 'space-y-4';

                const tableHeader = document.createElement('div');
                tableHeader.className = 'grid grid-cols-12 gap-4 px-4 text-sm font-bold text-gray-400 uppercase';
                tableHeader.innerHTML = `
                    <div class="col-span-3">Data de Chegada</div>
                    <div class="col-span-5">Código do Produto</div>
                    <div class="col-span-3 text-center">Quantidade</div>
                    <div class="col-span-1"></div>
                `;
                container.appendChild(tableHeader);

                const createProgrammingBlock = (item, parent) => {
                    const block = document.createElement('div');
                    block.className = 'programming-block bg-gray-800 p-3 rounded-lg grid grid-cols-12 gap-4 items-center';
                    
                    block.innerHTML = `
                        <input type="date" value="${item.date || ''}" class="programming-date col-span-3 bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition">
                        <input type="text" value="${item.code || ''}" placeholder="Ex: PROD-001" class="uppercase-input programming-code col-span-5 bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition">
                        <input type="number" value="${item.quantity || ''}" placeholder="Ex: 100" class="programming-quantity col-span-3 bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition text-center">
                        <button class="remove-btn col-span-1 px-3 py-2 bg-red-700 hover:bg-red-600 rounded-md text-sm font-medium transition-colors duration-150">Remover</button>
                    `;
                    
                    block.querySelector('.remove-btn').onclick = () => block.remove();
                    parent.appendChild(block);
                };
                
                addButton.onclick = () => createProgrammingBlock({}, container);

                // Sort by date before displaying
                PROGRAMMING_DATA.sort((a,b) => new Date(a.date) - new Date(b.date));
                PROGRAMMING_DATA.forEach(item => createProgrammingBlock(item, container));
                
                fileInput.addEventListener('change', (event) => {
                    processUploadedFile(event.target.files[0], (data) => {
                        data.forEach(row => {
                            if (String(row[0]).toLowerCase().includes('data')) return; // skip header
                            if (row.length >= 3) {
                                let date = row[0];
                                if (typeof date === 'number') {
                                    const jsDate = XLSX.SSF.parse_date_code(date);
                                    date = `${jsDate.y}-${String(jsDate.m).padStart(2,'0')}-${String(jsDate.d).padStart(2,'0')}`;
                                } else if (typeof date === 'string' && date.includes('/')) {
                                    const [day, month, year] = date.split('/');
                                    const fullYear = year.length === 2 ? '20' + year : year;
                                    date = `${fullYear}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                                }
                                createProgrammingBlock({ date, code: row[1], quantity: row[2] }, container);
                            }
                        });
                        fileInput.value = '';
                    });
                });

                const saveButton = document.createElement('button');
                saveButton.textContent = 'Salvar Alterações';
                saveButton.className = 'mt-6 px-4 py-2 bg-green-600 hover:bg-green-500 rounded-md font-semibold transition-colors duration-150';
                saveButton.onclick = () => {
                    const newData = [];
                    mainContent.querySelectorAll('.programming-block').forEach(block => {
                        const date = block.querySelector('.programming-date').value;
                        const code = block.querySelector('.programming-code').value.trim().toUpperCase();
                        const quantity = block.querySelector('.programming-quantity').value.trim();
                        if (date && code && quantity) {
                            newData.push({ date, code, quantity });
                        }
                    });
                    
                    PROGRAMMING_DATA = newData;
                    saveData();
                    displayProgrammingScreen(true);
                };
                
                mainContent.appendChild(container);
                mainContent.appendChild(saveButton);
            }

            function processUploadedFile(file, callback) {
                const reader = new FileReader();
                const extension = file.name.split('.').pop().toLowerCase();

                if (extension === 'xlsx' || extension === 'xls') {
                    reader.onload = (e) => {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true, dateNF:'dd/mm/yyyy' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false, dateNF:'dd/mm/yyyy' });
                        callback(json);
                    };
                    reader.readAsArrayBuffer(file);
                } else { // csv, txt
                    reader.onload = (e) => {
                        const text = e.target.result;
                        const lines = text.split(/\r?\n/).filter(line => line.trim());
                        const dataAsArrays = lines.map(line => line.split(/[,;\t]/));
                        callback(dataAsArrays);
                    };
                    reader.readAsText(file);
                }
            }
            
            function displayForecastScreen(showConfirmation = false, confirmationMessage = 'Salvo com sucesso!') {
                mainContent.innerHTML = `
                    <div class="max-w-4xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-amber-400">Cadastro de Forecast de Saídas</h2>
                            <div class="flex items-center gap-4">
                                <label for="forecast-file-upload" class="cursor-pointer px-4 py-2 bg-green-600 hover:bg-green-500 rounded-md font-semibold transition-colors duration-150">
                                    Carregar Novo Forecast
                                </label>
                                <input id="forecast-file-upload" type="file" class="hidden" accept=".csv,.txt,.xls,.xlsx">
                            </div>
                        </div>
                        <p id="forecast-status" class="text-center mb-4 h-6 text-green-400"></p>
                        <div id="forecast-table-container" class="overflow-x-auto"></div>
                        <button id="save-forecast-changes" class="mt-6 px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-md font-semibold transition-colors duration-150">Salvar Alterações</button>
                    </div>`;

                const fileInput = document.getElementById('forecast-file-upload');
                const statusEl = document.getElementById('forecast-status');
                const tableContainer = document.getElementById('forecast-table-container');
                const saveButton = document.getElementById('save-forecast-changes');
                
                if(showConfirmation){
                    statusEl.textContent = confirmationMessage;
                    setTimeout(() => { statusEl.textContent = ''; }, 3000);
                }

                renderForecastTable(FORECAST_DATA, tableContainer);

                fileInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    statusEl.textContent = 'Processando arquivo...';
                    processUploadedFile(file, (data) => {
                         try {
                            if (data.length < 2) throw new Error("Arquivo inválido ou vazio.");

                            const newForecast = {};
                            const header = data[0];
                            const dates = header.slice(1).map(dateCell => {
                                let dateStr = String(dateCell).trim();
                                if (typeof dateCell === 'number') { // Excel date number
                                    const jsDate = XLSX.SSF.parse_date_code(dateCell);
                                    return `${jsDate.y}-${String(jsDate.m).padStart(2, '0')}-${String(jsDate.d).padStart(2, '0')}`;
                                }
                                if (dateStr.includes('/')) {
                                    const parts = dateStr.split('/');
                                    if(parts.length === 3) {
                                        const [day, month, year] = parts.map(p => p.trim());
                                        const fullYear = year.length === 2 ? '20' + year : year;
                                        return `${fullYear}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                    }
                                }
                                return dateStr; // Assume YYYY-MM-DD
                            });
                            
                            for (let i = 1; i < data.length; i++) {
                                const row = data[i];
                                const productCode = String(row[0]).trim().toUpperCase();
                                if (!productCode) continue;

                                for (let j = 1; j < row.length; j++) {
                                    const date = dates[j - 1];
                                    const quantity = parseFloat(row[j]);

                                    if (date && !isNaN(quantity) && quantity > 0) {
                                        if (!newForecast[date]) newForecast[date] = {};
                                        newForecast[date][productCode] = quantity;
                                    }
                                }
                            }
                            
                            FORECAST_DATA = newForecast; 
                            nextRenderMessage = `Arquivo carregado! ${Object.keys(newForecast).length} dias, ${data.length - 1} produtos. Clique em 'Salvar'.`;
                            refreshCurrentView();

                        } catch (error) {
                            console.error("Erro ao processar o arquivo de forecast:", error);
                            nextRenderMessage = 'Erro ao processar. Verifique o formato do arquivo.';
                            refreshCurrentView();
                        } finally {
                            fileInput.value = '';
                        }
                    });
                });

                saveButton.onclick = () => {
                    const newForecast = {};
                    mainContent.querySelectorAll('.forecast-row').forEach(row => {
                        const productCode = row.querySelector('.forecast-code').textContent.trim();
                        row.querySelectorAll('.forecast-qty').forEach(input => {
                            const date = input.dataset.date;
                            const quantity = parseFloat(input.value);
                            if (date && productCode && !isNaN(quantity) && quantity > 0) {
                                if(!newForecast[date]) newForecast[date] = {};
                                newForecast[date][productCode] = quantity;
                            }
                        });
                    });
                    
                    FORECAST_DATA = newForecast;
                    saveData();
                    nextRenderMessage = 'Alterações salvas com sucesso!';
                    refreshCurrentView();
                };
            }

            function renderForecastTable(forecastData, container) {
                const productForecasts = {};
                const allDates = new Set();
                for(const date in forecastData){
                    allDates.add(date);
                    for(const productCode in forecastData[date]){
                        if(!productForecasts[productCode]){
                            productForecasts[productCode] = {};
                        }
                        productForecasts[productCode][date] = forecastData[date][productCode];
                    }
                }
                const sortedDates = Array.from(allDates).sort();

                let tableHTML = '<table class="w-full text-left">';
                tableHTML += '<thead class="bg-gray-800"><tr><th class="p-2 sticky left-0 bg-gray-800">Produto</th>';
                sortedDates.forEach(date => {
                    const dateObj = new Date(date + 'T00:00:00');
                    const formattedDate = isNaN(dateObj) ? 'Data Inválida' : dateObj.toLocaleDateString('pt-BR');
                    tableHTML += `<th class="p-2 text-center">${formattedDate}</th>`;
                });
                tableHTML += '<th></th></tr></thead>';
                
                tableHTML += '<tbody>';
                Object.keys(productForecasts).sort().forEach(productCode => {
                    tableHTML += `<tr class="forecast-row border-b border-gray-700">`;
                    tableHTML += `<td class="p-2 font-semibold forecast-code sticky left-0 bg-gray-900">${productCode}</td>`;
                    sortedDates.forEach(date => {
                        const qty = productForecasts[productCode][date] || 0;
                        tableHTML += `<td class="p-1"><input type="number" class="w-24 bg-gray-700 text-center rounded p-1 forecast-qty" data-date="${date}" value="${qty}"></td>`;
                    });
                    tableHTML += `<td><button class="remove-btn px-2 py-1 bg-red-700 hover:bg-red-600 rounded text-xs">X</button></td>`;
                    tableHTML += `</tr>`;
                });
                tableHTML += '</tbody></table>';

                container.innerHTML = tableHTML;
                container.querySelectorAll('.remove-btn').forEach(btn => {
                    btn.onclick = (e) => e.target.closest('.forecast-row').remove();
                });
            }

            function runSimulation(simulationDate) {
                let simulatedInventory = JSON.parse(JSON.stringify(inventoryState));
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const simDate = new Date(simulationDate + 'T00:00:00');
                simDate.setHours(0,0,0,0);
                
                if (simDate < today) {
                    const statusEl = document.getElementById('simulation-status');
                    if(statusEl) statusEl.textContent = 'Não é possível simular para uma data passada.';
                    setTimeout(() => { if(statusEl) statusEl.textContent = ''; }, 3000);
                    return;
                }
                
                const timeDiff = simDate.getTime() - today.getTime();
                const dayDifference = Math.ceil(timeDiff / (1000 * 3600 * 24));
                
                for (let i = 0; i <= dayDifference; i++) {
                    const currentSimDay = new Date(today.getTime() + i * (1000 * 3600 * 24));
                    const currentSimDayString = currentSimDay.toISOString().split('T')[0];
                    
                    if (currentSimDay > today) {
                        const dailyConsumptionData = FORECAST_DATA[currentSimDayString] || {};

                        for(const productCode in dailyConsumptionData){
                            let consumptionNeeded = parseFloat(dailyConsumptionData[productCode]);
                            if(isNaN(consumptionNeeded) || consumptionNeeded <= 0) continue;

                            const addressesForProduct = Object.keys(simulatedInventory)
                                .filter(addr => simulatedInventory[addr].item.toUpperCase() === productCode.toUpperCase())
                                .sort(); 
                            
                            for(const address of addressesForProduct) {
                                if(consumptionNeeded <= 0) break;
                                
                                let currentQty = parseFloat(simulatedInventory[address].quantity);
                                const consumedFromThis = Math.min(currentQty, consumptionNeeded);
                                
                                currentQty -= consumedFromThis;
                                consumptionNeeded -= consumedFromThis;

                                if(currentQty <= 0) {
                                    delete simulatedInventory[address];
                                } else {
                                    const productParam = PRODUCT_PARAMS_DATA.find(p => p.code.toUpperCase() === productCode.toUpperCase());
                                    const maxQty = productParam ? parseFloat(productParam.maxQty) : 1;
                                    simulatedInventory[address].quantity = currentQty;
                                    simulatedInventory[address].percentage = maxQty > 0 ? (currentQty / maxQty) * 100 : 100;
                                }
                            }
                        }
                    }

                    const arrivalsForThisDay = PROGRAMMING_DATA.filter(p => p.date === currentSimDayString);
                    for (const arrival of arrivalsForThisDay) {
                        let quantityToAllocate = parseFloat(arrival.quantity);
                        if (isNaN(quantityToAllocate) || quantityToAllocate <= 0) continue;

                        const productParam = PRODUCT_PARAMS_DATA.find(p => p.code.toUpperCase() === arrival.code.toUpperCase());
                        const maxQty = productParam ? parseFloat(productParam.maxQty) : 1;
                        if (maxQty <= 0) continue;

                        const allLocations = [];
                        for (let r = 1; r <= WAREHOUSE_CONFIG.totalRacks; r++) {
                            const cols = WAREHOUSE_CONFIG.getColsForRack(r);
                            const levelLettersReversed = [...WAREHOUSE_CONFIG.levelLetters].reverse();
                            for (let c = 1; c <= cols; c++) {
                                for (const level of levelLettersReversed) {
                                    for (const s of WAREHOUSE_CONFIG.sides) {
                                        allLocations.push(`PP${String(r).padStart(2, '0')}.${String(c).padStart(2, '0')}.${WAREHOUSE_CONFIG.levelMap[level]}.${s}`);
                                    }
                                }
                            }
                        }
                        
                        const partialPallets = allLocations
                            .filter(addr => 
                                simulatedInventory[addr] &&
                                simulatedInventory[addr].item.toUpperCase() === arrival.code.toUpperCase() && 
                                parseFloat(simulatedInventory[addr].quantity) < maxQty
                            );
                        
                        for (const address of partialPallets) {
                            if (quantityToAllocate <= 0) break;

                            const pallet = simulatedInventory[address];
                            const currentQty = parseFloat(pallet.quantity);
                            const spaceAvailable = maxQty - currentQty;
                            const qtyToAdd = Math.min(quantityToAllocate, spaceAvailable);

                            pallet.quantity = currentQty + qtyToAdd;
                            pallet.percentage = (pallet.quantity / maxQty) * 100;
                            quantityToAllocate -= qtyToAdd;
                        }

                        if (quantityToAllocate > 0) {
                            for(const address of allLocations){
                                if(quantityToAllocate <= 0) break;
                                if (!simulatedInventory[address]) {
                                    const qtyForThisSlot = Math.min(quantityToAllocate, maxQty);
                                    quantityToAllocate -= qtyForThisSlot;
                                    simulatedInventory[address] = {
                                        item: arrival.code,
                                        quantity: qtyForThisSlot,
                                        percentage: (qtyForThisSlot / maxQty) * 100
                                    };
                                }
                            }
                        }
                    }
                }

                displayAllRacks(simulatedInventory, simulationDate);
                updateGlobalStats(simulatedInventory);
            }
            
            // --- INITIAL APP STARTUP ---
            async function initialize() {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid; // Capture the user ID
                        if(isInitialLoad){
                           setupRealtimeListener();
                        }
                    }
                });
                
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } catch (error) {
                        console.error("Erro ao autenticar com token customizado, tentando anônimo.", error);
                        if (!auth.currentUser) {
                           await signInAnonymously(auth);
                        }
                    }
                } else {
                    await signInAnonymously(auth);
                }
            }

            initialize();
        });
    </script>
</body>
</html>

